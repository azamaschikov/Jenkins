pipeline {

    agent any

    options {
        disableConcurrentBuilds()
        buildDiscarder(
            logRotator(
                numToKeepStr:"3",
                daysToKeepStr: "7",
                artifactDaysToKeepStr: "7",
                artifactNumToKeepStr: "3"
            )
        )
        ansiColor("gnome-terminal")
    }

    environment {
        IMAGE_TAG           = "v0.0.0"
        IMAGE_NAME          = "my-awesome-application:${env.IMAGE_TAG}"

        REPOSITORY_BRANCH   = ""
        REPOSITORY_ADDRESS  = ""

        REGISTRY_CREDENTIAL = ""
    }

    stages {

        stage("Clean Work Directory") {
            steps {
                cleanWs()
            }
        }

        stage("Clone Repository") {
            steps {
                checkout([$class: "GitSCM", branches: [[name: REPOSITORY_BRANCH]],
                userRemoteConfigs: [[url: REPOSITORY_ADDRESS]]])
            }
        }

        stage("Build Docker Image") {
            steps {
                sh "docker build --tag ${env.IMAGE_NAME} ."
            }
        }

        stage("Push Docker Image") {
            steps {
                withCredentials([usernamePassword(credentialsId: REGISTRY_CREDENTIAL, usernameVariable: "USERNAME", passwordVariable: "PASSWORD")]) {
                    sh "docker login --username ${env.USERNAME} --password ${env.PASSWORD}"
                    sh "docker push ${env.IMAGE_NAME}"
                }
            }
        }

    }

    post {
        success {
            echo "Success build"
        }

        failure {
            echo "Failure build"
        }

        always {
            cleanWs()
        }
    }
}
